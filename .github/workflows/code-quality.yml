name: ğŸ” AnÃ¡lise de Qualidade

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Executa toda sexta-feira Ã s 10h UTC para anÃ¡lise semanal
    - cron: '0 10 * * 5'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: AnÃ¡lise estÃ¡tica de cÃ³digo
  static-analysis:
    name: ğŸ“Š AnÃ¡lise EstÃ¡tica
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better analysis
          
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ” ESLint Analysis
        run: |
          echo "ğŸ” Executando anÃ¡lise ESLint para documentaÃ§Ã£o n8n PT-BR..."
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint -- --format stylish
        continue-on-error: true
        
      - name: ğŸ“ TypeScript Analysis
        run: |
          echo "ğŸ“ Verificando tipos TypeScript para componentes React..."
          npm run typecheck 2>&1 | tee typescript-report.txt || true
        continue-on-error: true
        
      - name: ğŸ“‹ Markdown Analysis
        run: |
          echo "ğŸ“‹ Analisando qualidade dos arquivos Markdown..."
          npm run markdown:lint > markdown-report.txt 2>&1 || true
          
          # Basic markdown statistics
          echo "ğŸ“Š EstatÃ­sticas Markdown:" >> markdown-report.txt
          echo "- Total MDX files: $(find docs/ -name "*.mdx" | wc -l)" >> markdown-report.txt
          echo "- Total MD files: $(find docs/ -name "*.md" | wc -l)" >> markdown-report.txt
          echo "- Total documentation files: $(find docs/ -name "*.md" -o -name "*.mdx" | wc -l)" >> markdown-report.txt
        continue-on-error: true
        
      - name: ğŸ”’ Dependency analysis
        run: |
          echo "ğŸ”’ Analisando dependÃªncias para vulnerabilidades..."
          npm audit --audit-level=low --json > audit-report.json || true
          npm outdated --json > outdated-report.json || true
        continue-on-error: true
        
      - name: ğŸ“¤ Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-analysis-reports-${{ github.run_number }}
          path: |
            eslint-report.json
            typescript-report.txt
            markdown-report.txt
            audit-report.json
            outdated-report.json
          retention-days: 30

  # Job 2: AnÃ¡lise de seguranÃ§a
  security-analysis:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ Executando auditoria de seguranÃ§a..."
          npm audit --audit-level=moderate || true
        continue-on-error: true
        
      - name: ğŸ” Vulnerability scanning
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
        
      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
        
      - name: ğŸ•µï¸ Content security check
        run: |
          echo "ğŸ•µï¸ Verificando conteÃºdo sensÃ­vel na documentaÃ§Ã£o..."
          
          # Check for potential secrets in documentation
          SENSITIVE_FOUND=0
          
          if grep -r -i "password.*=" docs/ --include="*.md" --include="*.mdx"; then
            echo "âš ï¸ PossÃ­veis senhas encontradas na documentaÃ§Ã£o"
            SENSITIVE_FOUND=1
          fi
          
          if grep -r -i "token.*=" docs/ --include="*.md" --include="*.mdx"; then
            echo "âš ï¸ PossÃ­veis tokens encontrados na documentaÃ§Ã£o"
            SENSITIVE_FOUND=1
          fi
          
          if grep -r -i "secret.*=" docs/ --include="*.md" --include="*.mdx"; then
            echo "âš ï¸ PossÃ­veis secrets encontrados na documentaÃ§Ã£o"
            SENSITIVE_FOUND=1
          fi
          
          if [ $SENSITIVE_FOUND -eq 0 ]; then
            echo "âœ… Nenhum conteÃºdo sensÃ­vel Ã³bvio encontrado"
          else
            echo "âš ï¸ Revise se hÃ¡ informaÃ§Ãµes sensÃ­veis expostas na documentaÃ§Ã£o"
          fi
        continue-on-error: true

  # Job 3: AnÃ¡lise de documentaÃ§Ã£o
  documentation-analysis:
    name: ğŸ“š AnÃ¡lise de DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ğŸ“Š Documentation structure analysis
        run: |
          echo "ğŸ“Š Analisando estrutura da documentaÃ§Ã£o n8n PT-BR..."
          
          echo "## ğŸ“š RelatÃ³rio de Qualidade da DocumentaÃ§Ã£o" > doc-analysis.md
          echo "" >> doc-analysis.md
          echo "**Projeto:** n8n Documentation PT-BR (NÃ£o Oficial)" >> doc-analysis.md
          echo "**Data da anÃ¡lise:** $(date -u)" >> doc-analysis.md
          echo "**Commit:** $GITHUB_SHA" >> doc-analysis.md
          echo "" >> doc-analysis.md
          
          # Count files by type and section
          echo "### ğŸ“Š Estrutura de Arquivos" >> doc-analysis.md
          echo "- **Total MDX:** $(find docs/ -name "*.mdx" | wc -l)" >> doc-analysis.md
          echo "- **Total MD:** $(find docs/ -name "*.md" | wc -l)" >> doc-analysis.md
          echo "- **DiretÃ³rios:** $(find docs/ -type d | wc -l)" >> doc-analysis.md
          echo "" >> doc-analysis.md
          
          # Analyze main sections
          echo "### ğŸ—‚ï¸ SeÃ§Ãµes Principais" >> doc-analysis.md
          for section in docs/*/; do
            if [ -d "$section" ]; then
              section_name=$(basename "$section")
              file_count=$(find "$section" -name "*.md" -o -name "*.mdx" | wc -l)
              echo "- **$section_name:** $file_count arquivo(s)" >> doc-analysis.md
            fi
          done
          echo "" >> doc-analysis.md
          
          # Analyze frontmatter quality
          echo "### ğŸ·ï¸ AnÃ¡lise de Frontmatter" >> doc-analysis.md
          missing_title=0
          missing_description=0
          total_files=0
          
          for file in $(find docs/ -name "*.mdx" -o -name "*.md"); do
            total_files=$((total_files + 1))
            if ! grep -q "title:" "$file"; then
              missing_title=$((missing_title + 1))
            fi
            if ! grep -q "description:" "$file"; then
              missing_description=$((missing_description + 1))
            fi
          done
          
          echo "- **Arquivos analisados:** $total_files" >> doc-analysis.md
          echo "- **Sem tÃ­tulo:** $missing_title" >> doc-analysis.md
          echo "- **Sem descriÃ§Ã£o:** $missing_description" >> doc-analysis.md
          echo "" >> doc-analysis.md
          
          # Check for Portuguese-specific content
          echo "### ğŸ‡§ğŸ‡· AnÃ¡lise de LocalizaÃ§Ã£o PT-BR" >> doc-analysis.md
          br_content=$(grep -r -i "brasil\|portuguÃªs\|pt-br" docs/ --include="*.md" --include="*.mdx" | wc -l)
          echo "- **ReferÃªncias ao Brasil/PortuguÃªs:** $br_content" >> doc-analysis.md
          echo "" >> doc-analysis.md
          
          cat doc-analysis.md
        continue-on-error: true
        
      - name: ğŸ”— Link validation analysis
        run: |
          echo "ğŸ”— Verificando qualidade dos links..."
          
          # Simple link analysis
          TOTAL_LINKS=$(grep -r "\[.*\](.*.)" docs/ --include="*.md" --include="*.mdx" | wc -l)
          RELATIVE_LINKS=$(grep -r "\[.*\](\.\./.*)" docs/ --include="*.md" --include="*.mdx" | wc -l)
          HTTP_LINKS=$(grep -r "\[.*\](http.*)" docs/ --include="*.md" --include="*.mdx" | wc -l)
          
          echo "ğŸ“Š EstatÃ­sticas de Links:" >> doc-analysis.md
          echo "- **Total de links:** $TOTAL_LINKS" >> doc-analysis.md
          echo "- **Links relativos:** $RELATIVE_LINKS" >> doc-analysis.md
          echo "- **Links HTTP/HTTPS:** $HTTP_LINKS" >> doc-analysis.md
          echo "" >> doc-analysis.md
        continue-on-error: true
        
      - name: ğŸ“¤ Upload documentation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: documentation-reports-${{ github.run_number }}
          path: |
            doc-analysis.md
          retention-days: 30

  # Job 4: ConsolidaÃ§Ã£o de relatÃ³rios
  quality-summary:
    name: ğŸ“‹ Resumo de Qualidade
    runs-on: ubuntu-latest
    needs: [static-analysis, security-analysis, documentation-analysis]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
          pattern: "*-${{ github.run_number }}"
          
      - name: ğŸ“Š Generate consolidated report
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio consolidado de qualidade..."
          
          cat > quality-summary.md << 'EOF'
          # ğŸ“‹ RelatÃ³rio Consolidado de Qualidade
          
          **Projeto:** n8n Documentation PT-BR (NÃ£o Oficial)
          **Data:** $(date -u)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## ğŸ¯ Status dos Jobs
          
          | Job | Status |
          |-----|--------|
          | **AnÃ¡lise EstÃ¡tica** | ${{ needs.static-analysis.result }} |
          | **AnÃ¡lise de SeguranÃ§a** | ${{ needs.security-analysis.result }} |
          | **AnÃ¡lise de DocumentaÃ§Ã£o** | ${{ needs.documentation-analysis.result }} |
          
          ## ğŸ“Š Resumo dos Achados
          
          ### ğŸ”’ SeguranÃ§a
          - Vulnerabilidades: Ver relatÃ³rio detalhado nos artifacts
          - ConteÃºdo sensÃ­vel: Verificado na documentaÃ§Ã£o
          - DependÃªncias: Auditoria realizada
          
          ### ğŸ“š DocumentaÃ§Ã£o
          - Estrutura: Analisada para projeto em portuguÃªs
          - Links: VerificaÃ§Ã£o bÃ¡sica realizada
          - LocalizaÃ§Ã£o PT-BR: ConteÃºdo brasileiro verificado
          
          ### ğŸ” CÃ³digo
          - ESLint: Ver eslint-report.json
          - TypeScript: Ver typescript-report.txt
          - Markdown: Ver markdown-report.txt
          
          ## ğŸ¯ RecomendaÃ§Ãµes
          
          1. **Prioridade Alta:** Corrigir vulnerabilidades de seguranÃ§a
          2. **Prioridade MÃ©dia:** Resolver warnings do ESLint e TypeScript
          3. **Prioridade Baixa:** Melhorar frontmatter da documentaÃ§Ã£o
          4. **EspecÃ­fico PT-BR:** Manter consistÃªncia na localizaÃ§Ã£o
          
          ## ğŸ“¦ Artifacts DisponÃ­veis
          
          Todos os relatÃ³rios detalhados estÃ£o disponÃ­veis nos artifacts desta action:
          - `code-analysis-reports-${{ github.run_number }}`
          - `documentation-reports-${{ github.run_number }}`
          
          ---
          
          **DocumentaÃ§Ã£o n8n PT-BR** - AnÃ¡lise automatizada de qualidade
          EOF
          
          # Substituir variÃ¡veis
          envsubst < quality-summary.md > quality-summary-final.md
          
          cat quality-summary-final.md
          
      - name: ğŸ“¤ Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary-${{ github.run_number }}
          path: quality-summary-final.md
          retention-days: 30
          
      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const staticAnalysis = '${{ needs.static-analysis.result }}';
            const securityAnalysis = '${{ needs.security-analysis.result }}';
            const docAnalysis = '${{ needs.documentation-analysis.result }}';
            
            let comment = `## ğŸ” RelatÃ³rio de Qualidade do CÃ³digo\n\n`;
            comment += `**n8n Documentation PT-BR** - AnÃ¡lise de qualidade automÃ¡tica\n\n`;
            
            // Status dos jobs
            comment += `### ğŸ“Š Status das VerificaÃ§Ãµes\n\n`;
            comment += `| VerificaÃ§Ã£o | Status |\n`;
            comment += `|-------------|--------|\n`;
            comment += `| **AnÃ¡lise EstÃ¡tica** | ${staticAnalysis === 'success' ? 'âœ… Sucesso' : 'âŒ Falhou'} |\n`;
            comment += `| **SeguranÃ§a** | ${securityAnalysis === 'success' ? 'âœ… Sucesso' : 'âŒ Falhou'} |\n`;
            comment += `| **DocumentaÃ§Ã£o** | ${docAnalysis === 'success' ? 'âœ… Sucesso' : 'âŒ Falhou'} |\n\n`;
            
            // Links para relatÃ³rios
            comment += `### ğŸ“ RelatÃ³rios Detalhados\n\n`;
            comment += `Todos os relatÃ³rios estÃ£o disponÃ­veis nos [artifacts desta action](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}):\n\n`;
            comment += `- ğŸ“Š **AnÃ¡lise de CÃ³digo:** \`code-analysis-reports-${context.runNumber}\`\n`;
            comment += `- ğŸ“š **AnÃ¡lise de DocumentaÃ§Ã£o:** \`documentation-reports-${context.runNumber}\`\n`;
            comment += `- ğŸ“‹ **Resumo Consolidado:** \`quality-summary-${context.runNumber}\`\n\n`;
            
            comment += `### ğŸ¯ PrÃ³ximos Passos\n\n`;
            comment += `1. ğŸ“¥ Baixar e revisar os relatÃ³rios de qualidade\n`;
            comment += `2. ğŸ”§ Corrigir issues crÃ­ticos identificados\n`;
            comment += `3. ğŸ”„ Re-executar as verificaÃ§Ãµes se necessÃ¡rio\n`;
            comment += `4. ğŸ‡§ğŸ‡· Manter qualidade da documentaÃ§Ã£o em portuguÃªs\n`;
            
            // Verificar se Ã© realmente um PR antes de comentar
            if (context.issue && context.issue.pull_request && context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log('NÃ£o Ã© um PR, pulando comentÃ¡rio');
            }