name: üìã Valida√ß√£o de Pull Request

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'static/**'
      - '*.ts'
      - '*.json'
      - '*.md'
      - '*.mdx'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

concurrency:
  group: pr-validation-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  # Job 1: Valida√ß√£o de c√≥digo e build
  code-validation:
    name: üîç Valida√ß√£o de C√≥digo
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}
      lint-success: ${{ steps.lint.outcome == 'success' }}
      
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üöÄ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîç ESLint validation
        id: lint
        run: |
          echo "Running ESLint validation for documentation project..."
          npm run lint:check
        continue-on-error: true
        
      - name: üìù TypeScript validation
        id: typecheck
        run: |
          echo "Validating TypeScript types for React components..."
          npm run typecheck
        continue-on-error: true
        
      - name: üìã Markdown linting
        id: markdown-lint
        run: |
          echo "Checking markdown syntax and style..."
          npm run markdown:lint
        continue-on-error: true
        
      - name: üõ†Ô∏è Build documentation
        id: build
        run: |
          echo "Building n8n documentation in Portuguese..."
          npm run build
          echo "Build completed. Checking for common issues..."
          
          # Check if critical pages were generated
          if [ -f "build/index.html" ]; then
            echo "‚úÖ Homepage generated successfully"
          else
            echo "‚ùå Homepage missing"
            exit 1
          fi
          
          if [ -f "build/intro/index.html" ]; then
            echo "‚úÖ Intro page generated successfully"
          else
            echo "‚ùå Intro page missing"
          fi
        continue-on-error: true
        
      - name: üì§ Upload build artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: n8n-docs-build-pr-${{ github.event.number }}
          path: |
            build/
            !build/**/*.map
          retention-days: 7
          
      - name: üìä Generate build summary
        run: |
          echo "## üìä Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** n8n Documentation PT-BR" >> $GITHUB_STEP_SUMMARY
          echo "**PR #:** ${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- **ESLint:** ${{ steps.lint.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript:** ${{ steps.typecheck.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Markdown:** ${{ steps.markdown-lint.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ steps.build.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outcome }}" = "success" ]; then
            BUILD_SIZE=$(du -sh build/ | cut -f1)
            FILE_COUNT=$(find build -type f | wc -l)
            echo "### üì¶ Build Stats" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Files:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifacts:** Available for download" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: üí¨ Comment build status
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = '${{ steps.build.outcome }}' === 'success';
            const lintSuccess = '${{ steps.lint.outcome }}' === 'success';
            const typecheckSuccess = '${{ steps.typecheck.outcome }}' === 'success';
            const markdownSuccess = '${{ steps.markdown-lint.outcome }}' === 'success';
            
            let comment = `## üî® Status da Valida√ß√£o\n\n`;
            comment += `**n8n Documentation PT-BR** - Valida√ß√£o de Pull Request #${{ github.event.number }}\n\n`;
            
            comment += `| Verifica√ß√£o | Status |\n`;
            comment += `|-------------|--------|\n`;
            comment += `| **ESLint** | ${lintSuccess ? '‚úÖ Passou' : '‚ùå Falhou'} |\n`;
            comment += `| **TypeScript** | ${typecheckSuccess ? '‚úÖ Passou' : '‚ùå Falhou'} |\n`;
            comment += `| **Markdown** | ${markdownSuccess ? '‚úÖ Passou' : '‚ùå Falhou'} |\n`;
            comment += `| **Build** | ${buildSuccess ? '‚úÖ Sucesso' : '‚ùå Falhou'} |\n\n`;
            
            if (buildSuccess) {
              comment += `üéâ **Build realizado com sucesso!** A documenta√ß√£o foi compilada sem erros cr√≠ticos.\n\n`;
              comment += `üì¶ **Artifacts dispon√≠veis:** Download na aba "Actions" > "Artifacts"\n\n`;
              comment += `### üìã Pr√≥ximos passos:\n`;
              comment += `- ‚úÖ Revisar as mudan√ßas na documenta√ß√£o\n`;
              comment += `- ‚úÖ Testar navega√ß√£o e funcionalidades\n`;
              comment += `- ‚úÖ Verificar links internos\n`;
            } else {
              comment += `üö® **Build falhou!** Verifique os logs para detalhes sobre os erros.\n\n`;
              comment += `### üîß Como corrigir:\n`;
              comment += `1. Verifique os logs de build na aba "Actions"\n`;
              comment += `2. Corrija os erros reportados\n`;
              comment += `3. Execute \`npm run build\` localmente para testar\n`;
              comment += `4. Fa√ßa push das corre√ß√µes\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 2: An√°lise de qualidade da documenta√ß√£o
  quality-analysis:
    name: üìö An√°lise de Qualidade
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üöÄ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîç Documentation structure analysis
        run: |
          echo "## üìö An√°lise da Estrutura da Documenta√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files by type
          MDX_COUNT=$(find docs/ -name "*.mdx" | wc -l)
          MD_COUNT=$(find docs/ -name "*.md" | wc -l)
          TOTAL_DOCS=$((MDX_COUNT + MD_COUNT))
          
          echo "### üìä Estat√≠sticas" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de documentos:** $TOTAL_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "- **Arquivos MDX:** $MDX_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Arquivos MD:** $MD_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for common documentation issues
          echo "### üîç Verifica√ß√µes" >> $GITHUB_STEP_SUMMARY
          
          # Check for files without frontmatter
          FILES_WITHOUT_TITLE=0
          for file in $(find docs/ -name "*.mdx" -o -name "*.md"); do
            if ! grep -q "title:" "$file"; then
              FILES_WITHOUT_TITLE=$((FILES_WITHOUT_TITLE + 1))
            fi
          done
          
          if [ $FILES_WITHOUT_TITLE -eq 0 ]; then
            echo "- ‚úÖ Todos os arquivos possuem t√≠tulo" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è $FILES_WITHOUT_TITLE arquivo(s) sem t√≠tulo" >> $GITHUB_STEP_SUMMARY
          fi
        
      - name: üîó Basic link validation
        run: |
          echo "Verificando links b√°sicos..."
          # Simple check for obviously broken links
          BROKEN_LINKS=$(grep -r "\[.*\](\.\..*)" docs/ --include="*.md" --include="*.mdx" | wc -l)
          
          if [ $BROKEN_LINKS -eq 0 ]; then
            echo "‚úÖ Nenhum link relativo suspeito encontrado"
          else
            echo "‚ö†Ô∏è $BROKEN_LINKS poss√≠veis links relativos encontrados"
          fi
        continue-on-error: true

  # Job 3: Verifica√ß√£o de seguran√ßa
  security-check:
    name: üîí Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üöÄ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîí Security audit
        run: |
          echo "Executando auditoria de seguran√ßa..."
          npm audit --audit-level=moderate || echo "Audit completed with warnings"
        continue-on-error: true
        
      - name: üîç Check for sensitive content
        run: |
          echo "Verificando conte√∫do sens√≠vel..."
          
          # Check for potential secrets or sensitive data
          if grep -r -i "password\|token\|secret\|key.*=" docs/ --include="*.md" --include="*.mdx"; then
            echo "‚ö†Ô∏è Poss√≠vel conte√∫do sens√≠vel encontrado na documenta√ß√£o"
            echo "Revise se n√£o h√° senhas ou tokens expostos"
          else
            echo "‚úÖ Nenhum conte√∫do sens√≠vel √≥bvio encontrado"
          fi
        continue-on-error: true

  # Job 4: Resumo final
  validation-summary:
    name: üìã Resumo da Valida√ß√£o
    runs-on: ubuntu-latest
    needs: [code-validation, quality-analysis, security-check]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: üìä Generate final summary
        uses: actions/github-script@v7
        with:
          script: |
            const codeValidation = '${{ needs.code-validation.result }}';
            const qualityAnalysis = '${{ needs.quality-analysis.result }}';
            const securityCheck = '${{ needs.security-check.result }}';
            
            let comment = `## üìã Resumo Final da Valida√ß√£o\n\n`;
            comment += `**Pull Request:** #${{ github.event.number }}\n`;
            comment += `**Branch:** ${{ github.head_ref }}\n`;
            comment += `**Autor:** @${{ github.event.pull_request.user.login }}\n\n`;
            
            comment += `### üîç Status dos Jobs\n\n`;
            comment += `| Job | Status |\n`;
            comment += `|-----|--------|\n`;
            comment += `| **Valida√ß√£o de C√≥digo** | ${codeValidation === 'success' ? '‚úÖ Sucesso' : '‚ùå Falhou'} |\n`;
            comment += `| **An√°lise de Qualidade** | ${qualityAnalysis === 'success' ? '‚úÖ Sucesso' : '‚ùå Falhou'} |\n`;
            comment += `| **Verifica√ß√£o de Seguran√ßa** | ${securityCheck === 'success' ? '‚úÖ Sucesso' : '‚ùå Falhou'} |\n\n`;
            
            const allPassed = codeValidation === 'success' && qualityAnalysis === 'success' && securityCheck === 'success';
            
            if (allPassed) {
              comment += `üéâ **Todas as valida√ß√µes passaram!** Este PR est√° pronto para revis√£o.\n\n`;
              comment += `### üìã Checklist final:\n`;
              comment += `- ‚úÖ C√≥digo validado e compilado\n`;
              comment += `- ‚úÖ Qualidade da documenta√ß√£o verificada\n`;
              comment += `- ‚úÖ Verifica√ß√µes de seguran√ßa aprovadas\n`;
              comment += `- üì¶ Artifacts de build dispon√≠veis\n\n`;
              comment += `> **Pronto para merge ap√≥s revis√£o humana** üöÄ`;
            } else {
              comment += `‚ö†Ô∏è **Algumas valida√ß√µes falharam.** Verifique os logs para detalhes.\n\n`;
              comment += `### üîß Pr√≥ximos passos:\n`;
              comment += `1. Revisar os erros nos jobs que falharam\n`;
              comment += `2. Corrigir os problemas identificados\n`;
              comment += `3. Fazer push das corre√ß√µes\n`;
              comment += `4. Aguardar nova execu√ß√£o da valida√ß√£o\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });